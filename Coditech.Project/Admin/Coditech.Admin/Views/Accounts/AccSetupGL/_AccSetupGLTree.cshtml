@model AccSetupGLModel
@{
    Layout = null;
}

<!-- Main Content -->
<div id="main-content">
    <div id="category-container" style="margin:5px;">
        @if (Model?.AccSetupCategoryList?.Any() == true)
        {
            foreach (var cat in Model.AccSetupCategoryList)
            {
                @Html.Raw(RenderAccSetupCategoryTree(cat))
                <div id="cat-gl-@cat.AccSetupCategoryId" style="display:none;">
                    @foreach (var gl in Model?.AccSetupGLList?.Where(x => x.CategoryCode == cat.CategoryCode))
                    {
                        @Html.Raw(RenderAccSetupGLTree(gl, cat.AccSetupCategoryId))
                    }
                </div>
            }
        }
        else
        {
            <div class="col-sm-12 col-md-5">
                <strong class="text-danger">No Result Found</strong>
            </div>
        }
    </div>
</div>

<!-- Render the Child Modal Partial View -->
@Html.Partial("~/Views/Accounts/AccSetupGL/_ChildModel.cshtml", Model)

@functions {
    string RenderAccSetupCategoryTree(AccSetupCategoryModel cat)
    {
        string folderIcon = "📂";
        string amount = "<span>0.00</span>";
        string chevron = $"<span id='cat-chevron-{cat.AccSetupCategoryId}' style='cursor:pointer; margin-right:5px;'>▶</span>";
        string inlineActions = $@"
<span id='cat-buttons-{cat.AccSetupCategoryId}' style='margin-left:5px; display:none;'>
  <button type='button' class='btn btn-sm btn-soft-success btn-circle add-child-btn'
          data-categoryid='{cat.AccSetupCategoryId}' data-parentid='0'>
    <i class='fas ti-plus'></i>
  </button>
</span>";

        return $@"
<div id='cat-{cat.AccSetupCategoryId}' style='padding-left:10px; margin-bottom:10px;'>
  <div style='display:flex; justify-content:space-between; align-items:center; padding:12px;
              border:1px solid #dee2e6; border-radius:4px; background-color:#fff;
              cursor:pointer;'
       onclick='toggleSubAccounts(""cat"", {cat.AccSetupCategoryId})'>
    <div style='display:flex; align-items:center;'>
      <span>{folderIcon}</span>
      <span>{cat.CategoryName} ({cat.CategoryCode})</span>
      <span>{chevron} {inlineActions}</span>
    </div>
    <div>{amount}</div>
  </div>
</div>";
    }

    string RenderAccSetupGLTree(AccSetupGLModel gl, int categoryId)
    {
        bool isFolder = gl.IsGroup || (gl.SubAccounts?.Any() == true);
        string icon = isFolder ? "📂" : "📄";
        string amount = "<span>0.00</span>";
        string chevron = isFolder ? $"<span id='gl-chevron-{gl.AccSetupGLId}' style='cursor:pointer; margin-right:5px;'>▶</span>" : "";
        string inlineActions = isFolder ? $@"
<span id='gl-buttons-{gl.AccSetupGLId}' style='margin-left:5px; display:none;'>
  <button type='button' class='btn btn-sm btn-soft-success btn-circle add-child-btn'
          data-parentid='{gl.AccSetupGLId}' data-categoryid='{categoryId}'>
    <i class='fas ti-plus'></i>

  </button>
</span>" : "";

        string html = $@"
<div id='gl-{gl.AccSetupGLId}' style='padding-left:20px; margin-bottom:8px;'>
  <div style='display:flex; justify-content:space-between; align-items:center; padding:8px;
              border:1px solid #dee2e6; border-radius:4px; background-color:#fff;
              cursor:pointer;'
       onclick='toggleSubAccounts(""gl"", {gl.AccSetupGLId})'>
    <div style='display:flex; align-items:center;'>
      <span>{icon}</span>
      <span>{gl.GLName} ({gl.GLCode})</span>
      <span>{chevron} {inlineActions}</span>
    </div>
    <div>{amount}</div>
  </div>
  <div id='gl-subaccounts-{gl.AccSetupGLId}' style='padding-left:30px; border-left:1px solid #dee2e6; margin-top:8px; display:none;'>";

        if (isFolder)
        {
            foreach (var sub in gl.SubAccounts)
            {
                html += RenderAccSetupGLTree(sub, categoryId);
            }
        }
        html += "</div></div>";
        return html;
    }
}
<script>
       function toggleSubAccounts(type, id) {
        var sub = document.getElementById(type === "cat" ? "cat-gl-" + id : "gl-subaccounts-" + id);
        var chev = document.getElementById(type === "cat" ? "cat-chevron-" + id : "gl-chevron-" + id);
        var actions = document.getElementById(type === "cat" ? "cat-buttons-" + id : "gl-buttons-" + id);

        if (sub) {
            var isExpanded = sub.style.display === "block";
            sub.style.display = isExpanded ? "none" : "block";
            if (actions) actions.style.display = isExpanded ? "none" : "inline";
        }

        if (chev) {
            var currentRotation = chev.style.transform === "rotate(90deg)" ? "rotate(0deg)" : "rotate(90deg)";
            chev.style.transform = currentRotation;
            chev.style.display = "inline-block"; // Ensures proper rendering
            chev.style.transition = "transform 0.3s ease-in-out"; // Smooth rotation
        }
    }
           (function () {
        var AccSetupGL = {
            Initialize: function () {
                console.log("AccSetupGL module initialized");
            },

            OpenAddChildModal: function (parentId, categoryId) {
                // Set hidden input values
                $('input[name="ParentAccSetupGLId"]').val(parentId);
                $('input[name="AccSetupCategoryId"]').val(categoryId);
                $('#childGLName').val("");
                $('#childGLCode').val("");
                $('#addChildModal').modal('show');

                var balanceSheetId = $("#AccSetupBalancesheetId").val();
                var balanceSheetTypeId = $("#AccSetupBalanceSheetTypeId").val();
                var chartTemplateId = $("#AccSetupChartOfAccountTemplateId").val();

                $('input[name="AccSetupBalancesheetId"]').val(balanceSheetId);
                $('input[name="AccSetupBalanceSheetTypeId"]').val(balanceSheetTypeId);
                $('input[name="AccSetupChartOfAccountTemplateId"]').val(chartTemplateId);

                // Clear previous error messages when modal is opened
                AccSetupGL.ClearError();
            },

            AddChild: function () {
                var formData = $("#addChildForm").serialize();
                console.log("Submitting AddChild Form:", formData);

                // Clear previous error messages
                AccSetupGL.ClearError();

                $.ajax({
                    type: "POST",
                    url: "/AccSetupGL/AddChild",
                    data: formData,
                    success: function (response) {
                        console.log("Response:", response);

                        if (response.success) {
                            $('#addChildModal').modal('hide'); // Close modal only on success

                            // Show success notification
                            CoditechNotification.DisplayNotificationMessage("Record added successfully!", "success");

                            // Reload after delay
                            setTimeout(function () {
                                location.reload();
                            }, 2000);
                        } else {
                            // Show error message inside the modal
                            AccSetupGL.ShowError(response.message || "GL Name or GL Code already exists.");
                        }
                    },
                    error: function () {
                        // Show error message inside the modal
                        AccSetupGL.ShowError("An error occurred while adding the record. Please try again.");
                    }
                });
            },

            ShowError: function (message) {
                $("#addChildErrorText").text(message);
                $("#addChildErrorMessage").removeClass("d-none").addClass("fade show"); // Smooth visibility
            },

            ClearError: function () {
                $("#addChildErrorMessage").addClass("d-none").removeClass("fade show");
                $("#addChildErrorText").text("");
            }
        };

        // Expose the module to the global scope
        window.AccSetupGL = AccSetupGL;

        // Open Add Child modal when button is clicked
        $(document).on("click", ".add-child-btn", function () {
            var parentId = $(this).data('parentid');
            var categoryId = $(this).data('categoryid');
            AccSetupGL.OpenAddChildModal(parentId, categoryId);
        });

        // Submit form when Add Child button is clicked
        $(document).on("click", "#submitAddChild", function () {
            AccSetupGL.AddChild();
        });

        // Initialize the module on page load
        $(document).ready(function () {
            AccSetupGL.Initialize();
        });
    })();

</script>
